<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>IRB Protocol Drafting - AI-Enhanced Collaboration</title>
    <link rel="stylesheet" href="main.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/nprogress/nprogress.css" />
    <script src="https://unpkg.com/nprogress/nprogress.js"></script>
    <style>
      .tabs-nav {
        display: flex;
        border-bottom: 2px solid #ccc;
        margin-bottom: 1em;
        list-style: none;
        padding: 0;
      }
      .tabs-nav li {
        margin-right: 1em;
        padding: 0.5em 1em;
        cursor: pointer;
        border: 1px solid transparent;
        border-top-left-radius: 8px;
        border-top-right-radius: 8px;
      }
      .tabs-nav li.active {
        border-color: #ccc;
        border-bottom-color: white;
        background: white;
      }
      .tab-content > div {
        display: none;
      }
      .tab-content > div.active {
        display: block;
      }
      .ai-upload-section {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 12px;
        margin: 20px 0;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .upload-area {
        border: 2px dashed rgba(255, 255, 255, 0.5);
        border-radius: 8px;
        padding: 30px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        margin: 15px 0;
      }

      .upload-area:hover {
        border-color: rgba(255, 255, 255, 0.8);
        background: rgba(255, 255, 255, 0.1);
      }

      .upload-area.dragover {
        border-color: #4caf50;
        background: rgba(76, 175, 80, 0.1);
      }

      .processing-indicator {
        display: none;
        text-align: center;
        padding: 20px;
      }

      .spinner {
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top: 3px solid white;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto 10px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .ai-suggestion {
        background: rgba(255, 255, 255, 0.1);
        border-left: 4px solid #4caf50;
        padding: 10px;
        margin: 5px 0;
        border-radius: 4px;
        font-size: 0.9em;
      }

      .accept-suggestion-btn {
        background: #4caf50;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.8em;
        margin-left: 10px;
      }

      .collab-section {
        position: relative;
      }

      .suggestion-overlay {
        position: absolute;
        top: 0;
        right: 0;
        background: #4caf50;
        color: white;
        padding: 5px 10px;
        border-radius: 0 0 0 8px;
        font-size: 0.8em;
        display: none;
      }

      .has-suggestion .suggestion-overlay {
        display: block;
      }

      .error-message {
        background: #f44336;
        color: white;
        padding: 10px;
        border-radius: 4px;
        margin: 10px 0;
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="navbar-placeholder"></div>
    <script>
      window.addEventListener("DOMContentLoaded", async () => {
        const params = new URLSearchParams(window.location.search);
        const draftTitle = params.get("draftTitle");
        if (!draftTitle || draftTitle === "new") {
          console.log("üÜï Starting fresh draft");
          return; // don't load anything
        }

        const res = await fetch(
          `/load-draft?title=${encodeURIComponent(draftTitle)}`
        );
        if (!res.ok) return;

        const data = await res.json();

        if (data.sections) {
          for (let id of sectionIds) {
            if (data.sections[id]) {
              document.getElementById(id).value = data.sections[id];
            }
          }
        }

        if (data.extraForms) {
          for (const [formId, savedInputs] of Object.entries(data.extraForms)) {
            const waitForForm = async () => {
              const formWrapper =
                document.querySelector(`[data-form-id="${formId}"] form`) ||
                document.getElementById(formId);
              if (!formWrapper) {
                console.warn(`‚è≥ Waiting for form ${formId}...`);
                setTimeout(waitForForm, 300);
                return;
              }

              for (const [key, value] of Object.entries(savedInputs)) {
                const inputs = formWrapper.querySelectorAll(`[name="${key}"]`);
                inputs.forEach((input) => {
                  if (input.type === "checkbox") {
                    input.checked =
                      Array.isArray(value) && value.includes(input.value);
                  } else if (input.type === "radio") {
                    input.checked = input.value === value;
                  } else {
                    input.value = value;
                  }
                });
              }
            };
            waitForForm();
          }
        }

        const saveBtnTemplate = document.createElement("button");
        saveBtnTemplate.textContent = "üíæ Save Draft";
        saveBtnTemplate.className = "universal-save-btn";
        saveBtnTemplate.style.marginTop = "30px";

        saveBtnTemplate.addEventListener("click", async (e) => {
          const btn = e.target;
          btn.textContent = "üíæ Saving...";

          const title =
            document.getElementById("section-1")?.value || "Untitled";
          if (title === "Untitled") {
            alert("Please enter a study title before saving.");
            return;
          }

          const sections = {};
          for (let id of sectionIds) {
            const el = document.getElementById(id);
            if (el) sections[id] = el.value;
          }

          const extraForms = {};
          document.querySelectorAll(".tab-content form").forEach((form) => {
            const formId =
              form.closest("[data-form-id]")?.getAttribute("data-form-id") ||
              form.getAttribute("id") ||
              "unknown_form";
            const inputs = form.querySelectorAll("input, textarea, select");

            const data = {};
            inputs.forEach((input) => {
              if (input.type === "checkbox") {
                if (!data[input.name]) data[input.name] = [];
                if (input.checked) data[input.name].push(input.value);
              } else if (input.type === "radio") {
                if (input.checked) data[input.name] = input.value;
              } else {
                data[input.name] = input.value;
              }
            });

            extraForms[formId] = data;
          });

          const response = await fetch("/save-draft", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ title, sections, extraForms }),
          });

          if (response.ok) {
            btn.textContent = "‚úÖ Saved!";
            setTimeout(() => (btn.textContent = "üíæ Save Draft"), 2000);
          } else {
            btn.textContent = "‚ùå Save Failed";
          }
        });

        // Add Save button to every loaded tab
        document.querySelectorAll(".tab-content > div").forEach((tab) => {
          const btnClone = saveBtnTemplate.cloneNode(true);
          btnClone.addEventListener("click", saveBtnTemplate.onclick);
          tab.appendChild(btnClone);
        });
      });

      console.log("üöÄ Script started");

      fetch("/navbar.html")
        .then((res) => res.text())
        .then((html) => {
          console.log("‚úÖ navbar.html loaded");
          document.getElementById("navbar-placeholder").innerHTML = html;

          setTimeout(() => {
            const navLinks = document.querySelector(".nav-links");
            if (!navLinks) {
              console.error("‚ùå navLinks element missing");
              return;
            }

            fetch("/session")
              .then((res) => {
                if (!res.ok) throw new Error("Not logged in");
                return res.json();
              })
              .then((user) => {
                console.log("‚úÖ Logged in:", user);
                navLinks.innerHTML = `
              <li><a href="/">Home</a></li>
              <li><a href="/dashboard">My Lab</a></li>
              <li>
                <form action="/logout" method="POST" style="display:inline;">
                  <button style="background:none;border:none;color:white;cursor:pointer;">Logout</button>
                </form>
              </li>
            `;

                const authSection = document.querySelector(".auth-section");
                if (authSection) authSection.style.display = "none";

                const cta = document.querySelector(".cta-button");
                if (cta) {
                  cta.href = "/dashboard";
                  cta.innerText = "Go to Dashboard";
                }
              })
              .catch((err) => {
                console.warn("‚ö†Ô∏è Not logged in:", err);
                navLinks.innerHTML = `
              <li><a href="/">Home</a></li>
              <li><a href="/login.html">Log In</a></li>
              <li><a href="/register.html">Register</a></li>
            `;

                const authSection = document.querySelector(".auth-section");
                if (authSection) authSection.style.display = "block";
              });
          }, 50);
        });
    </script>

    <div class="page-wrapper">
      <ul class="tabs-nav" id="tabs-nav">
        <li class="active" data-tab="protocol">Protocol Draft</li>
      </ul>
      <div class="tab-content">
        <!-- Protocol Draft Tab -->
        <div id="tab-protocol" class="active">
          <div class="intro-banner">
            <h1>ü§ñ AI-Enhanced Collaborative IRB Draft</h1>
            <p>
              Upload your existing study document and let AI help fill out your
              IRB protocol sections.
            </p>
          </div>

          <p id="live-users" style="color: green; font-weight: bold">
            üë• Live viewers: 1
          </p>

          <!-- AI Upload Section -->
          <div class="ai-upload-section">
            <h2>üìÑ Upload Study Document for AI Analysis</h2>
            <p>
              Upload a PDF of your existing study materials, and our AI will
              analyze it to suggest content for each IRB section.
            </p>

            <div class="upload-area" id="uploadArea">
              <div id="uploadPrompt">
                <h3>üìé Drop PDF here or click to upload</h3>
                <p>Supported format: PDF (max 10MB)</p>
                <input
                  type="file"
                  id="pdfInput"
                  accept=".pdf"
                  style="display: none"
                />
              </div>

              <div class="processing-indicator" id="processingIndicator">
                <div class="spinner"></div>
                <p>üß† AI is analyzing your document...</p>
                <p><small>This may take 30-60 seconds</small></p>
              </div>
            </div>

            <div class="error-message" id="errorMessage"></div>

            <div id="analysisResults" style="display: none">
              <h3>‚úÖ Analysis Complete!</h3>
              <p>
                AI has generated suggestions for your IRB sections. Look for the
                green "AI Suggestion" badges on each section below.
              </p>
              <button
                id="applyAllSuggestions"
                style="
                  background: #4caf50;
                  color: white;
                  border: none;
                  padding: 10px 20px;
                  border-radius: 4px;
                  cursor: pointer;
                  margin: 10px 0;
                "
              >
                üöÄ Apply All AI Suggestions
              </button>
            </div>
          </div>

          <p>
            Each section below is collaborative and auto-synced across users.
          </p>

          <div class="collab-section" data-section="1">
            <div class="suggestion-overlay">AI Suggestion Available</div>
            <h2>1. Study Title</h2>
            <div id="suggestion-1" class="ai-suggestion" style="display: none">
              <strong>AI Suggestion:</strong>
              <span class="suggestion-text"></span>
              <button
                class="accept-suggestion-btn"
                onclick="acceptSuggestion(1)"
              >
                Accept
              </button>
            </div>
            <textarea
              id="section-1"
              placeholder="Enter Study Title..."
            ></textarea>
          </div>

          <div class="collab-section" data-section="2">
            <div class="suggestion-overlay">AI Suggestion Available</div>
            <h2>2. Principal Investigator</h2>
            <div id="suggestion-2" class="ai-suggestion" style="display: none">
              <strong>AI Suggestion:</strong>
              <span class="suggestion-text"></span>
              <button
                class="accept-suggestion-btn"
                onclick="acceptSuggestion(2)"
              >
                Accept
              </button>
            </div>
            <textarea
              id="section-2"
              placeholder="Name, email, department..."
            ></textarea>
          </div>

          <div class="collab-section" data-section="3">
            <div class="suggestion-overlay">AI Suggestion Available</div>
            <h2>3. Purpose of the Study</h2>
            <div id="suggestion-3" class="ai-suggestion" style="display: none">
              <strong>AI Suggestion:</strong>
              <span class="suggestion-text"></span>
              <button
                class="accept-suggestion-btn"
                onclick="acceptSuggestion(3)"
              >
                Accept
              </button>
            </div>
            <textarea
              id="section-3"
              placeholder="Brief description of study aims..."
            ></textarea>
          </div>

          <div class="collab-section" data-section="4">
            <div class="suggestion-overlay">AI Suggestion Available</div>
            <h2>4. Background and Significance</h2>
            <div id="suggestion-4" class="ai-suggestion" style="display: none">
              <strong>AI Suggestion:</strong>
              <span class="suggestion-text"></span>
              <button
                class="accept-suggestion-btn"
                onclick="acceptSuggestion(4)"
              >
                Accept
              </button>
            </div>
            <textarea
              id="section-4"
              placeholder="Background literature, rationale..."
            ></textarea>
          </div>

          <div class="collab-section" data-section="5">
            <div class="suggestion-overlay">AI Suggestion Available</div>
            <h2>5. Subject Population</h2>
            <div id="suggestion-5" class="ai-suggestion" style="display: none">
              <strong>AI Suggestion:</strong>
              <span class="suggestion-text"></span>
              <button
                class="accept-suggestion-btn"
                onclick="acceptSuggestion(5)"
              >
                Accept
              </button>
            </div>
            <textarea
              id="section-5"
              placeholder="Age, sex, inclusion/exclusion criteria..."
            ></textarea>
          </div>

          <div class="collab-section" data-section="6">
            <div class="suggestion-overlay">AI Suggestion Available</div>
            <h2>6. Recruitment Methods</h2>
            <div id="suggestion-6" class="ai-suggestion" style="display: none">
              <strong>AI Suggestion:</strong>
              <span class="suggestion-text"></span>
              <button
                class="accept-suggestion-btn"
                onclick="acceptSuggestion(6)"
              >
                Accept
              </button>
            </div>
            <textarea
              id="section-6"
              placeholder="Flyers, MTurk, databases, etc..."
            ></textarea>
          </div>

          <div class="collab-section" data-section="7">
            <div class="suggestion-overlay">AI Suggestion Available</div>
            <h2>7. Research Procedures</h2>
            <div id="suggestion-7" class="ai-suggestion" style="display: none">
              <strong>AI Suggestion:</strong>
              <span class="suggestion-text"></span>
              <button
                class="accept-suggestion-btn"
                onclick="acceptSuggestion(7)"
              >
                Accept
              </button>
            </div>
            <textarea
              id="section-7"
              placeholder="Step-by-step breakdown..."
            ></textarea>
          </div>

          <div class="collab-section" data-section="8">
            <div class="suggestion-overlay">AI Suggestion Available</div>
            <h2>8. Risks and Discomforts</h2>
            <div id="suggestion-8" class="ai-suggestion" style="display: none">
              <strong>AI Suggestion:</strong>
              <span class="suggestion-text"></span>
              <button
                class="accept-suggestion-btn"
                onclick="acceptSuggestion(8)"
              >
                Accept
              </button>
            </div>
            <textarea
              id="section-8"
              placeholder="Describe all risks involved..."
            ></textarea>
          </div>

          <div class="collab-section" data-section="9">
            <div class="suggestion-overlay">AI Suggestion Available</div>
            <h2>9. Benefits</h2>
            <div id="suggestion-9" class="ai-suggestion" style="display: none">
              <strong>AI Suggestion:</strong>
              <span class="suggestion-text"></span>
              <button
                class="accept-suggestion-btn"
                onclick="acceptSuggestion(9)"
              >
                Accept
              </button>
            </div>
            <textarea
              id="section-9"
              placeholder="What do participants gain? Society?"
            ></textarea>
          </div>

          <div class="collab-section" data-section="10">
            <div class="suggestion-overlay">AI Suggestion Available</div>
            <h2>10. Data and Confidentiality</h2>
            <div id="suggestion-10" class="ai-suggestion" style="display: none">
              <strong>AI Suggestion:</strong>
              <span class="suggestion-text"></span>
              <button
                class="accept-suggestion-btn"
                onclick="acceptSuggestion(10)"
              >
                Accept
              </button>
            </div>
            <textarea
              id="section-10"
              placeholder="How will data be stored, de-identified, shared..."
            ></textarea>
          </div>

          <div class="collab-section" data-section="11">
            <div class="suggestion-overlay">AI Suggestion Available</div>
            <h2>11. Informed Consent Process</h2>
            <div id="suggestion-11" class="ai-suggestion" style="display: none">
              <strong>AI Suggestion:</strong>
              <span class="suggestion-text"></span>
              <button
                class="accept-suggestion-btn"
                onclick="acceptSuggestion(11)"
              >
                Accept
              </button>
            </div>
            <textarea
              id="section-11"
              placeholder="Who will obtain consent? Describe process..."
            ></textarea>
          </div>

          <div class="collab-section" data-section="12">
            <div class="suggestion-overlay">AI Suggestion Available</div>
            <h2>12. Attachments (e.g. Consent Forms)</h2>
            <div id="suggestion-12" class="ai-suggestion" style="display: none">
              <strong>AI Suggestion:</strong>
              <span class="suggestion-text"></span>
              <button
                class="accept-suggestion-btn"
                onclick="acceptSuggestion(12)"
              >
                Accept
              </button>
            </div>
            <textarea
              id="section-12"
              placeholder="Describe supporting documents..."
            ></textarea>
          </div>
          <hr style="margin-top: 40px" />
          <div style="margin-top: 20px">
            <h3>Invite Collaborator</h3>
            <input
              type="email"
              id="invite-email"
              placeholder="Enter email to invite"
              style="padding: 8px; width: 250px"
            />
            <button onclick="inviteCollaborator()" style="padding: 8px 12px">
              ‚ûï Invite
            </button>
            <p id="invite-status" style="margin-top: 10px; color: green"></p>
          </div>

          <button id="download-draft" style="margin-top: 30px">
            üì• Download Full Draft
          </button>
          <button id="submit-final" style="margin-left: 10px; background: #2196f3; color: white; padding: 10px 20px; border: none; border-radius: 5px;">
  ‚úÖ Submit Final Protocol
</button>


        </div>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();
      const sectionIds = [
        "section-1",
        "section-2",
        "section-3",
        "section-4",
        "section-5",
        "section-6",
        "section-7",
        "section-8",
        "section-9",
        "section-10",
        "section-11",
        "section-12",
      ];

      const autosaveTimers = {};
      const aiSuggestions = {};
      const params = new URLSearchParams(window.location.search);
      const draftTitle = params.get("draftTitle") || "default";

      // Original collaboration functionality
      sectionIds.forEach((id) => {
        const textarea = document.getElementById(id);

        socket.on(`${draftTitle}-${id}-init`, (text) => {
          textarea.value = text;
        });

        socket.on(`${draftTitle}-${id}-update`, (text) => {
          textarea.value = text;
        });

        textarea.addEventListener("input", () => {
          if (autosaveTimers[id]) clearTimeout(autosaveTimers[id]);
          autosaveTimers[id] = setTimeout(() => {
            const content = textarea.value;
            socket.emit("section-edit", { section: id, content, draftTitle });
          }, 2000);
        });
      });

      // Viewer count functionality
      socket.on("viewer-count", (count) => {
        const viewerText =
          count === 1 ? "üë§ 1 viewer online" : `üë• ${count} viewers online`;
        document.getElementById("live-users").textContent = viewerText;
      });


      // AI Upload functionality
      const uploadArea = document.getElementById("uploadArea");
      const pdfInput = document.getElementById("pdfInput");
      const processingIndicator = document.getElementById(
        "processingIndicator"
      );
      const uploadPrompt = document.getElementById("uploadPrompt");
      const errorMessage = document.getElementById("errorMessage");
      const analysisResults = document.getElementById("analysisResults");

      // Upload area event listeners
      uploadArea.addEventListener("click", () => pdfInput.click());
      uploadArea.addEventListener("dragover", handleDragOver);
      uploadArea.addEventListener("drop", handleDrop);
      uploadArea.addEventListener("dragleave", handleDragLeave);
      pdfInput.addEventListener("change", handleFileSelect);

      function handleDragOver(e) {
        e.preventDefault();
        uploadArea.classList.add("dragover");
      }

      function handleDragLeave(e) {
        e.preventDefault();
        uploadArea.classList.remove("dragover");
      }

      function handleDrop(e) {
        e.preventDefault();
        uploadArea.classList.remove("dragover");
        const files = e.dataTransfer.files;
        if (files.length > 0 && files[0].type === "application/pdf") {
          processPDF(files[0]);
        } else {
          showError("Please upload a valid PDF file.");
        }
      }

      function handleFileSelect(e) {
        const file = e.target.files[0];
        if (file && file.type === "application/pdf") {
          processPDF(file);
        } else {
          showError("Please select a valid PDF file.");
        }
      }

      async function processPDF(file) {
        if (file.size > 10 * 1024 * 1024) {
          showError("File size must be less than 10MB.");
          return;
        }

        uploadPrompt.style.display = "none";
        processingIndicator.style.display = "block";
        errorMessage.style.display = "none";

        try {
          const pdfText = await extractTextFromPDF(file);
          const suggestions = await analyzeWithAI(pdfText);
          displaySuggestions(suggestions);

          processingIndicator.style.display = "none";
          analysisResults.style.display = "block";
        } catch (error) {
          console.error("Error processing PDF:", error);
          showError("Error analyzing PDF. Please try again.");
          processingIndicator.style.display = "none";
          uploadPrompt.style.display = "block";
        }
      }

      async function extractTextFromPDF(file) {
        try {
          const arrayBuffer = await file.arrayBuffer();

          pdfjsLib.GlobalWorkerOptions.workerSrc =
            "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

          const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
          let fullText = "";

          for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const textContent = await page.getTextContent();
            const pageText = textContent.items
              .map((item) => item.str)
              .join(" ");
            fullText += pageText + "\n";
          }

          console.log("Extracted text length:", fullText.length);
          return fullText;
        } catch (error) {
          console.error("PDF extraction error:", error);
          throw new Error("Failed to extract text from PDF");
        }
      }

      async function analyzeWithAI(pdfText) {
        console.log("Sending to OpenAI API, text length:", pdfText.length);

        try {
          const response = await fetch("/api/analyze", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ pdfText: pdfText }),
          });

          console.log("API response status:", response.status);

          if (!response.ok) {
            const errorData = await response.json();
            console.error("API error:", errorData);
            throw new Error("API request failed: " + errorData.error);
          }

          const data = await response.json();
          console.log("API response received successfully");
          console.log("Full API response:", data);

          const content = data.choices[0].message.content;
          console.log("OpenAI content:", content);

          try {
            let parsedContent;

            if (typeof content === "string") {
              const jsonMatch = content.match(/\{[\s\S]*\}/);
              if (jsonMatch) {
                parsedContent = JSON.parse(jsonMatch[0]);
              } else {
                throw new Error("No JSON found in response");
              }
            } else if (typeof content === "object") {
              parsedContent = content;
            } else {
              throw new Error("Unexpected content type");
            }

            console.log("Parsed suggestions:", parsedContent);
            return parsedContent;
          } catch (parseError) {
            console.log("JSON parsing failed:", parseError);
            console.log("Raw content:", content);
            return createIntelligentFallback(pdfText);
          }
        } catch (error) {
          console.error("API call failed:", error);
          showError(
            `AI analysis failed: ${error.message}. Using document analysis fallback.`
          );
          return createIntelligentFallback(pdfText);
        }
      }

      function displaySuggestions(suggestions) {
        console.log("Displaying suggestions:", suggestions);

        if (!suggestions || typeof suggestions !== "object") {
          console.error("Invalid suggestions object:", suggestions);
          showError("Invalid suggestions received from AI");
          return;
        }

        const sectionMapping = {
          section1: "1",
          section2: "2",
          section3: "3",
          section4: "4",
          section5: "5",
          section6: "6",
          section7: "7",
          section8: "8",
          section9: "9",
          section10: "10",
          section11: "11",
          section12: "12",
        };

        let hasAnySuggestions = false;

        Object.keys(suggestions).forEach((key) => {
          const sectionNum = sectionMapping[key];

          if (!sectionNum) {
            console.warn(`Unknown section key: ${key}`);
            return;
          }

          const suggestionValue = suggestions[key];

          if (
            suggestionValue &&
            typeof suggestionValue === "string" &&
            suggestionValue.trim() !== "" &&
            suggestionValue !== "Not specified in document" &&
            suggestionValue !== "[object Object]"
          ) {
            console.log(
              `Setting suggestion for section ${sectionNum}:`,
              suggestionValue
            );

            const suggestionDiv = document.getElementById(
              `suggestion-${sectionNum}`
            );
            const suggestionText =
              suggestionDiv?.querySelector(".suggestion-text");
            const sectionDiv = document.querySelector(
              `[data-section="${sectionNum}"]`
            );

            if (suggestionDiv && suggestionText && sectionDiv) {
              suggestionText.textContent = suggestionValue;
              suggestionDiv.style.display = "block";
              sectionDiv.classList.add("has-suggestion");
              aiSuggestions[sectionNum] = suggestionValue;
              hasAnySuggestions = true;
            } else {
              console.log(
                `Skipping empty/invalid suggestion for section ${sectionNum}:`,
                suggestionValue
              );
            }
          } else {
            console.log(
              `Skipping empty/invalid suggestion for section ${sectionNum}:`,
              suggestionValue
            );
          }
        });

        if (hasAnySuggestions) {
          console.log("Successfully displayed suggestions");
        } else {
          console.warn("No valid suggestions to display");
          showError(
            "AI analysis completed but no valid suggestions were generated. Please try again or check your document."
          );
        }
      }

      function createIntelligentFallback(pdfText) {
        console.log("Creating intelligent suggestions from PDF text");
        const suggestions = {};
        const text = pdfText.toLowerCase();

        if (text.includes("ultrasound") && text.includes("breast")) {
          suggestions.section1 =
            "Conformable ultrasound breast patch for deep tissue scanning and imaging";
          suggestions.section2 =
            "Canan Dagdeviren, Media Lab, Massachusetts Institute of Technology";
          suggestions.section3 =
            "To develop and evaluate a wearable conformable ultrasound breast patch (cUSBr-Patch) for standardized breast tissue imaging";
          suggestions.section4 =
            "Current ultrasound technologies face challenges in wearable integration and consistent breast imaging. This research addresses gaps in automated, repeatable breast screening technology.";
          suggestions.section5 =
            "Adult participants suitable for breast ultrasound imaging, excluding those with significant health problems or skin diseases";
          suggestions.section6 =
            "Recruitment through institutional channels and voluntary participation from eligible candidates";
          suggestions.section7 =
            "Participants will wear the conformable ultrasound patch while imaging is performed using the phased array system at multiple positions and angles";
          suggestions.section8 =
            "Minimal risk involving non-invasive ultrasound imaging with standard safety protocols";
          suggestions.section9 =
            "Advancement of wearable medical imaging technology with potential for improved breast cancer screening and early detection";
          suggestions.section10 =
            "Data will be de-identified and stored securely according to institutional data protection guidelines";
          suggestions.section11 =
            "Written informed consent will be obtained by trained research personnel prior to any study procedures";
          suggestions.section12 =
            "Informed consent forms, device technical specifications, imaging protocols, and safety documentation";
        } else {
          const titleMatch = pdfText.match(/^(.{10,100}?)(?:\n|\.)/);
          suggestions.section1 = titleMatch
            ? titleMatch[1].trim()
            : "Research study extracted from document";

          const authorMatch = pdfText.match(
            /([A-Z][a-z]+ [A-Z][a-z]+(?:, [A-Z][a-z]+ [A-Z][a-z]+)*)/
          );
          suggestions.section2 = authorMatch
            ? authorMatch[1]
            : "Principal Investigator identified in document";

          suggestions.section3 =
            "Study objectives and research aims as described in the uploaded document";
          suggestions.section4 =
            "Background and scientific rationale based on literature review in the document";
          suggestions.section5 =
            "Study population and participant criteria as specified in the research protocol";
          suggestions.section6 =
            "Participant recruitment strategies outlined in the methodology";
          suggestions.section7 =
            "Research procedures and experimental protocol as detailed in the document";
          suggestions.section8 =
            "Potential risks and safety considerations identified in the study design";
          suggestions.section9 =
            "Expected benefits to participants and scientific advancement";
          suggestions.section10 =
            "Data management and confidentiality procedures following institutional guidelines";
          suggestions.section11 =
            "Informed consent process conducted by qualified research personnel";
          suggestions.section12 =
            "Supporting documentation including consent forms and study materials";
        }

        return suggestions;
      }

      function acceptSuggestion(sectionNum) {
        const textarea = document.getElementById(`section-${sectionNum}`);
        const suggestion = aiSuggestions[sectionNum];

        if (suggestion) {
          textarea.value = suggestion;
          socket.emit("section-edit", {
            section: `section-${sectionNum}`,
            content: suggestion,
          });

          const suggestionDiv = document.getElementById(
            `suggestion-${sectionNum}`
          );
          suggestionDiv.style.display = "none";
          const sectionDiv = document.querySelector(
            `[data-section="${sectionNum}"]`
          );
          sectionDiv.classList.remove("has-suggestion");
        }
      }

      function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = "block";
      }

      document
        .getElementById("applyAllSuggestions")
        .addEventListener("click", () => {
          Object.keys(aiSuggestions).forEach((sectionNum) => {
            acceptSuggestion(sectionNum);
          });
          analysisResults.style.display = "none";
        });

      document
        .getElementById("download-draft")
        .addEventListener("click", () => {
          const lines = [];
          sectionIds.forEach((id, idx) => {
            const textarea = document.getElementById(id);
            const title =
              document.querySelector(`h2[for="${id}"]`)?.textContent ||
              document.querySelector(
                `.collab-section[data-section="${idx + 1}"] h2`
              )?.textContent ||
              `Section ${idx + 1}`;
            lines.push(`\n\n=== ${title} ===\n${textarea.value.trim()}`);
          });

          const blob = new Blob([lines.join("\n")], { type: "text/plain" });
          const url = URL.createObjectURL(blob);

          const a = document.createElement("a");
          a.href = url;
          a.download = "IRB_Draft_AI_Enhanced.txt";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
        });

      // FIXED: Enhanced tab loading system
      document.addEventListener("DOMContentLoaded", async () => {
        const params = new URLSearchParams(window.location.search);

        // Step 1: Check if we have a saved draft to load
        const draftTitle = params.get("draftTitle");
        let savedDraft = null;
        if (draftTitle === "new") {
          console.log("üßº Clearing old inputs for new draft");
          sectionIds.forEach((id) => {
            const el = document.getElementById(id);
            if (el) el.value = "";
          });
          return;
        }

        if (draftTitle && draftTitle !== "new") {
          try {
            const res = await fetch(
              `/load-draft?title=${encodeURIComponent(draftTitle)}`
            );


            if (res.ok) {
              savedDraft = await res.json();
              console.log("üìã Loaded saved draft:", savedDraft);
            }
        if (savedDraft && savedDraft.extraForms) {
  const extraFormsNeeded = Object.keys(savedDraft.extraForms);
  const nav = document.getElementById("tabs-nav");
  const content = document.querySelector(".tab-content");

  const formMappings = [
    { field: "dod_funded", title: "DoD Exempt Application", file: "dodexempt.html" },
    { field: "mit_reviewing_irb", title: "Local Context", file: "localcontext.html" },
    { field: "conducting_interviews", title: "Consent to Participate in Interview", file: "consentpart.html" },
    { field: "submitting_genomic_data", title: "Genomic Data Sharing Certification", file: "datasharing.html" },
    { field: "lincoln_lab", title: "Scientific Review (Lincoln Lab only)", file: "scientific.html" },
    { field: "adverse_events", title: "Protocol Event Reporting", file: "protocol.html" },
    { field: "study_complete", title: "Final Report Closure", file: "finalreport.html" },
    { field: "not_in_english", title: "Translation Attestation", file: "translation.html" },
    { field: "wants_waiver", title: "Waiver or Alteration of Informed Consent Request", file: "waiver.html" },
    { field: "is_genomic", title: "Genomic Data Sharing Certification", file: "datasharing.html" },
    { field: "uses_phi", title: "Authorization for Release of PHI", file: "release.html" },
    { field: "involves_minors", title: "Assent for Minors", file: "assentform.html" },
  ];

  for (const formField of extraFormsNeeded) {
    const mapping = formMappings.find((m) => m.field === formField);
    if (mapping) {
      const li = document.createElement("li");
      li.textContent = mapping.title;
      li.dataset.tab = mapping.field;
      nav.appendChild(li);

      const tabDiv = document.createElement("div");
      tabDiv.id = `tab-${mapping.field}`;
      tabDiv.setAttribute("data-form-id", mapping.field);
      content.appendChild(tabDiv);

      const res = await fetch(mapping.file);
      const html = await res.text();
      tabDiv.innerHTML = html;
      tabDiv.style.display = "none";
    }
  }
}

          } catch (err) {
            console.warn("‚ö†Ô∏è Could not load saved draft:", err);
          }
        }

        // Step 2: Determine which extra forms to load
        let extraFormsNeeded = [];

        // If we have a saved draft, get the extra forms from it
        if (savedDraft && savedDraft.extraForms) {
          extraFormsNeeded = Object.keys(savedDraft.extraForms);
          console.log("üìù Extra forms from saved draft:", extraFormsNeeded);
        } else {
          // Otherwise, check URL parameters for form flags
          const formMappings = [
            {
              field: "dod_funded",
              title: "DoD Exempt Application",
              file: "dodexempt.html",
            },
            {
              field: "mit_reviewing_irb",
              title: "Local Context",
              file: "localcontext.html",
            },
            {
              field: "conducting_interviews",
              title: "Consent to Participate in Interview",
              file: "consentpart.html",
            },

            {
              field: "lincoln_lab",
              title: "Scientific Review (Lincoln Lab only)",
              file: "scientific.html",
            },
            {
              field: "adverse_events",
              title: "Protocol Event Reporting",
              file: "protocol.html",
            },
            {
              field: "study_complete",
              title: "Final Report Closure",
              file: "finalreport.html",
            },
            {
              field: "not_in_english",
              title: "Translation Attestation",
              file: "translation.html",
            },
            {
              field: "wants_waiver",
              title: "Waiver or Alteration of Informed Consent Request",
              file: "waiver.html",
            },
            {
              field: "is_genomic",
              title: "Genomic Data Sharing Certification",
              file: "datasharing.html",
            },
            {
              field: "uses_phi",
              title: "Authorization for Release of PHI",
              file: "release.html",
            },
            {
              field: "involves_minors",
              title: "Assent for Minors",
              file: "assentform.html",
            },
          ];

          for (const mapping of formMappings) {
            if (params.has(mapping.field)) {
              extraFormsNeeded.push(mapping.field);
            }
          }
          console.log("üìù Extra forms from URL params:", extraFormsNeeded);
        }

        // Step 3: Load extra form tabs
        const nav = document.getElementById("tabs-nav");
        const content = document.querySelector(".tab-content");

        const formMappings = [
          {
            field: "dod_funded",
            title: "DoD Exempt Application",
            file: "dodexempt.html",
          },
          {
            field: "mit_reviewing_irb",
            title: "Local Context",
            file: "localcontext.html",
          },
          {
            field: "conducting_interviews",
            title: "Consent to Participate in Interview",
            file: "consentpart.html",
          },
          {
            field: "submitting_genomic_data",
            title: "Genomic Data Sharing Certification",
            file: "datasharing.html",
          },
          {
            field: "lincoln_lab",
            title: "Scientific Review (Lincoln Lab only)",
            file: "scientific.html",
          },
          {
            field: "adverse_events",
            title: "Protocol Event Reporting",
            file: "protocol.html",
          },
          {
            field: "study_complete",
            title: "Final Report Closure",
            file: "finalreport.html",
          },
          {
            field: "not_in_english",
            title: "Translation Attestation",
            file: "translation.html",
          },
          {
            field: "wants_waiver",
            title: "Waiver or Alteration of Informed Consent Request",
            file: "waiver.html",
          },
          {
            field: "is_genomic",
            title: "Genomic Data Sharing Certification",
            file: "datasharing.html",
          },
          {
            field: "uses_phi",
            title: "Authorization for Release of PHI",
            file: "release.html",
          },
          {
            field: "involves_minors",
            title: "Assent for Minors",
            file: "assentform.html",
          },
        ];

        for (const formField of extraFormsNeeded) {
          const mapping = formMappings.find((m) => m.field === formField);
          if (mapping) {
            const li = document.createElement("li");
            li.textContent = mapping.title;
            li.dataset.tab = mapping.field;
            nav.appendChild(li);

            const tabDiv = document.createElement("div");
            tabDiv.id = `tab-${mapping.field}`;
            tabDiv.setAttribute("data-form-id", mapping.field);
            content.appendChild(tabDiv);

            try {
              const res = await fetch(mapping.file);
              const html = await res.text();
              tabDiv.innerHTML = html;
              tabDiv.style.display = "none";
              console.log(`‚úÖ Loaded form: ${mapping.title}`);
            } catch (err) {
              console.error(`‚ùå Failed to load ${mapping.file}:`, err);
              tabDiv.innerHTML = `<p style="color:red;">Error loading ${mapping.title} (${mapping.file})</p>`;
            }

            // If this was the Protocol Event Reporting form, hook up its download button:
            // helper: hook a download button to grab fields, build a .txt and trigger download
            function setupDownload(tabDiv, btnSelector, filename, fields) {
              const btn = tabDiv.querySelector(btnSelector);
              if (!btn) return;
              btn.addEventListener("click", () => {
                const lines = [];
                fields.forEach(({ selector, label, multiple, isCheckbox }) => {
                  const els = tabDiv.querySelectorAll(selector);
                  let value;
                  if (multiple) {
                    value = Array.from(els)
                      .filter((el) => el.checked)
                      .map((el) => el.value);
                  } else if (isCheckbox) {
                    // single checkbox: show ‚ÄúYes‚Äù/‚ÄúNo‚Äù
                    const el = els[0];
                    value = el && el.checked ? ["Yes"] : ["No"];
                  } else {
                    const el = els[0];
                    if (!el) {
                      value = [""];
                    } else if (
                      el.tagName === "SELECT" ||
                      el.tagName === "INPUT" ||
                      el.tagName === "TEXTAREA"
                    ) {
                      value = [el.value.trim()];
                    } else {
                      value = [el.textContent.trim()];
                    }
                  }
                  lines.push(
                    `\n\n=== ${label} ===\n${
                      value.length ? value.join(", ") : "‚Äî"
                    }`
                  );
                });
                const blob = new Blob([lines.join("")], { type: "text/plain" });
                const a = document.createElement("a");
                a.href = URL.createObjectURL(blob);
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);
              });
            }

            switch (mapping.field) {
              // I. Protocol Event Reporting
              case "adverse_events":
                setupDownload(
                  tabDiv,
                  "#downloadTxtBtn",
                  "Protocol_Event_Report.txt",
                  [
                    {
                      selector: 'input[name="reportTypes"]',
                      multiple: true,
                      label: "What is being reported?",
                    },
                    { selector: "#titleOfStudy", label: "Title of Study" },
                    { selector: "#piName", label: "Principal Investigator" },
                    { selector: "#irbNumber", label: "Protocol/IRB Number" },
                    { selector: "#eventDate", label: "Date of Event" },
                    { selector: "#description", label: "Detailed Description" },
                    { selector: "#actionsTaken", label: "Actions Taken" },
                  ]
                );
                break;

              // II. Genomic Data Sharing
              case "is_genomic":
                setupDownload(
                  tabDiv,
                  "#downloadDataSharingBtn",
                  "Genomic_Data_Sharing.txt",
                  [
                    { selector: "#study_title", label: "Title of Study" },
                    { selector: "#pi_name", label: "Principal Investigator" },
                    { selector: "#contact_person", label: "Contact Person" },
                    { selector: "#contact_email", label: "Contact Email" },
                    {
                      selector: 'input[name="dataset_type"]',
                      multiple: true,
                      label: "Request Type",
                    },
                    {
                      selector: 'input[name="dul"]',
                      multiple: true,
                      label: "Data Use Limitations",
                    },
                    { selector: "#controlled_uses", label: "Allowed Uses" },
                    { selector: "#pop_desc", label: "Population Description" },
                    {
                      selector: "#data_fields",
                      label: "Data Fields Submitted",
                    },
                    { selector: "#seq_type", label: "Sequencing Type" },
                    { selector: "#coding_method", label: "Coding Method" },
                    {
                      selector: "#key_maintenance",
                      label: "Code Key Maintenance",
                    },
                    {
                      selector: "#sensitive_info",
                      label: "Sensitive Populations",
                    },
                    { selector: "#pi_sig", label: "Investigator Signature" },
                    { selector: "#pi_date", label: "Date" },
                  ]
                );
                break;

              // III. Waiver/Alteration of Consent
              case "wants_waiver":
                setupDownload(
                  tabDiv,
                  "#downloadWaiverBtn",
                  "Waiver_Alteration_Request.txt",
                  [
                    {
                      selector: 'input[name="request_type"]',
                      multiple: true,
                      label: "Type of Request",
                    },
                    {
                      selector: 'textarea[name="practicable"]',
                      label: "Why Practicable Without Waiver?",
                    },
                    {
                      selector: 'select[name="risk"]',
                      label: "More Than Minimal Risk?",
                    },
                    {
                      selector: 'textarea[name="risk_details"]',
                      label: "Risk Details",
                    },
                    {
                      selector: 'select[name="debrief"]',
                      label: "Will Debrief?",
                    },
                    {
                      selector: 'textarea[name="debrief_text"]',
                      label: "Debriefing Text",
                    },
                  ]
                );
                break;

              // IV. Translation Attestation
              case "not_in_english":
                setupDownload(
                  tabDiv,
                  "#downloadTranslationBtn",
                  "Translation_Attestation.txt",
                  [
                    {
                      selector: 'input[name="study_title"]',
                      label: "Title of Study",
                    },
                    { selector: 'input[name="pi_name"]', label: "PI Name" },
                    {
                      selector: 'input[name="pi_room"]',
                      label: "Building & Room",
                    },
                    { selector: 'input[name="pi_title"]', label: "Title" },
                    { selector: 'input[name="pi_email"]', label: "Email" },
                    { selector: 'input[name="pi_dept"]', label: "Department" },
                    { selector: 'input[name="pi_phone"]', label: "Phone" },
                    {
                      selector: 'textarea[name="doc_list"]',
                      label: "Translated Documents",
                    },
                    {
                      selector: 'input[name="pi_signature"]',
                      label: "PI Signature",
                    },
                    { selector: 'input[name="pi_date"]', label: "PI Date" },
                    {
                      selector: 'input[name="translator_signature"]',
                      label: "Translator Signature",
                    },
                    {
                      selector: 'input[name="translator_date"]',
                      label: "Translator Date",
                    },
                  ]
                );
                break;

              // V. Financial Interest Supplement
              case "supplement_disclosure":
                setupDownload(
                  tabDiv,
                  "#downloadSupplementBtn",
                  "Financial_Interest_Supplement.txt",
                  [
                    {
                      selector: 'input[name="study_title"]',
                      label: "Title of Study",
                    },
                    { selector: 'input[name="pi_name"]', label: "PI Name" },
                    {
                      selector: 'input[name="pi_room"]',
                      label: "Building & Room",
                    },
                    { selector: 'input[name="pi_title"]', label: "Title" },
                    { selector: 'input[name="pi_email"]', label: "Email" },
                    { selector: 'input[name="pi_dept"]', label: "Department" },
                    { selector: 'input[name="pi_phone"]', label: "Phone" },
                    {
                      selector: 'textarea[name="name_role"]',
                      label: "Name & Role",
                    },
                    {
                      selector: 'textarea[name="entity_rel"]',
                      label: "Entity & Relationship",
                    },
                    {
                      selector: 'input[name="interest_type"]',
                      multiple: true,
                      label: "Type of Interest",
                    },
                    {
                      selector: 'input[name="interest_other"]',
                      label: "Other Interest",
                    },
                    {
                      selector: 'textarea[name="supp_info"]',
                      label: "Supplemental Info",
                    },
                    {
                      selector: 'textarea[name="entity_desc"]',
                      label: "Entity & Role Description",
                    },
                    {
                      selector: 'textarea[name="relation_desc"]',
                      label: "Relation to Research",
                    },
                    { selector: 'input[name="signature"]', label: "Signature" },
                    { selector: 'input[name="sig_date"]', label: "Date" },
                  ]
                );
                break;

              // VI. Scientific Review
              case "lincoln_lab":
                setupDownload(
                  tabDiv,
                  "#downloadScientificBtn",
                  "Scientific_Review.txt",
                  [
                    {
                      selector: 'input[name="protocol"]',
                      label: "COUHES Protocol #",
                    },
                    {
                      selector: 'input[name="dept_head"]',
                      label: "Department Head Name",
                    },
                    {
                      selector: 'input[name="q1"]',
                      multiple: true,
                      label: "Least Risky Procedures?",
                    },
                    {
                      selector: 'input[name="q2"]',
                      multiple: true,
                      label: "Likely to Achieve Aims?",
                    },
                    {
                      selector: 'input[name="q3"]',
                      multiple: true,
                      label: "Sufficient Scientific Importance?",
                    },
                    {
                      selector: 'input[name="q4"]',
                      multiple: true,
                      label: "Adequate Resources?",
                    },
                    {
                      selector: 'textarea[name="comments"]',
                      label: "Reviewer's Comments",
                    },
                    { selector: 'input[name="signature"]', label: "Signature" },
                    { selector: 'input[name="sig_date"]', label: "Date" },
                  ]
                );
                break;

              // VII. Release of PHI
              case "uses_phi":
                setupDownload(
                  tabDiv,
                  "#downloadPHIReleaseBtn",
                  "Release_PHI.txt",
                  [
                    {
                      selector: 'textarea[name="study_title"]',
                      label: "Study Title",
                    },
                    {
                      selector: 'input[name="researcher"]',
                      label: "Researcher Name",
                    },
                    {
                      selector: 'textarea[name="phi_list"]',
                      label: "PHI to be Used",
                    },
                    { selector: 'textarea[name="purpose"]', label: "Purpose" },
                    {
                      selector: 'textarea[name="recipients"]',
                      label: "Recipients",
                    },
                    {
                      selector: 'input[name="expiration"]',
                      label: "Expiration",
                    },
                    {
                      selector: 'textarea[name="revocation"]',
                      label: "Revocation Process",
                    },
                    {
                      selector: 'input[name="subj_name"]',
                      label: "Subject Name",
                    },
                    {
                      selector: 'input[name="subj_date"]',
                      label: "Subject Date",
                    },
                    {
                      selector: 'input[name="inv_name"]',
                      label: "Investigator Name",
                    },
                    {
                      selector: 'input[name="inv_date"]',
                      label: "Investigator Date",
                    },
                    {
                      selector: 'input[name="witness_name"]',
                      label: "Witness Name",
                    },
                    {
                      selector: 'input[name="witness_date"]',
                      label: "Witness Date",
                    },
                  ]
                );
                break;

              // VIII. Local Context
              case "mit_reviewing_irb":
                setupDownload(
                  tabDiv,
                  "#downloadLocalContextBtn",
                  "Local_Context_Form.txt",
                  [
                    {
                      selector: 'input[name="study_title"]',
                      label: "Title of Study",
                    },
                    { selector: 'input[name="mit_pi"]', label: "MIT PI Name" },
                    {
                      selector: 'input[name="mit_contact"]',
                      label: "MIT Point of Contact",
                    },
                    {
                      selector: 'input[name="site_institution"]',
                      label: "Relying Site Institution",
                    },
                    {
                      selector: 'input[name="site_pi"]',
                      label: "Relying Site PI",
                    },
                    {
                      selector: 'select[name="state_laws"]',
                      label: "State Laws?",
                    },
                    {
                      selector: 'textarea[name="state_laws_desc"]',
                      label: "State Laws Description",
                    },
                    {
                      selector: 'select[name="cultural"]',
                      label: "Community/Cultural Differences?",
                    },
                    {
                      selector: 'textarea[name="cultural_desc"]',
                      label: "Cultural Differences Description",
                    },
                    {
                      selector: 'select[name="policies"]',
                      label: "IRB Policies?",
                    },
                    {
                      selector: 'textarea[name="policies_desc"]',
                      label: "IRB Policies Description",
                    },
                    {
                      selector: 'select[name="ancillary"]',
                      label: "Ancillary Reviews Complete?",
                    },
                    {
                      selector: 'select[name="coi"]',
                      label: "COI Identified?",
                    },
                    {
                      selector: 'textarea[name="coi_desc"]',
                      label: "COI Description",
                    },
                    {
                      selector: 'input[name="irb_rep"]',
                      label: "IRB Rep Name",
                    },
                    {
                      selector: 'input[name="irb_email"]',
                      label: "IRB Rep Email",
                    },
                    {
                      selector: 'input[name="irb_sig"]',
                      label: "IRB Rep Signature",
                    },
                    {
                      selector: 'input[name="irb_date"]',
                      label: "IRB Rep Date",
                    },
                  ]
                );
                break;

              // IX. Intake Form
              case "intakenew":
                setupDownload(
                  tabDiv,
                  "#downloadIntakeBtn",
                  "IRB_Intake_Form.txt",
                  [
                    { selector: 'input[name="title"]', label: "Study Title" },
                    {
                      selector: 'input[name="pi"]',
                      label: "Principal Investigator",
                    },
                    {
                      selector: 'input[name="irb_number"]',
                      label: "IRB Number",
                    },
                    {
                      selector: 'select[name="risk_level"]',
                      label: "Risk Level",
                    },
                    {
                      selector: 'textarea[name="description"]',
                      label: "Study Description",
                    },
                    {
                      selector: 'textarea[name="recruitment"]',
                      label: "Recruitment Details",
                    },
                    {
                      selector: 'input[name="consent"]',
                      isCheckbox: true,
                      label: "Consent Required?",
                    },
                    {
                      selector: 'input[name="involves_minors"]',
                      isCheckbox: true,
                      label: "Involves Minors?",
                    },
                    {
                      selector: 'input[name="uses_mturk"]',
                      isCheckbox: true,
                      label: "Uses MTurk?",
                    },
                    {
                      selector: 'input[name="uses_phi"]',
                      isCheckbox: true,
                      label: "Discloses PHI?",
                    },
                    {
                      selector: 'input[name="is_genomic"]',
                      isCheckbox: true,
                      label: "NIH-genomic?",
                    },
                    {
                      selector: 'input[name="wants_waiver"]',
                      isCheckbox: true,
                      label: "Waiver Requested?",
                    },
                    {
                      selector: 'input[name="not_in_english"]',
                      isCheckbox: true,
                      label: "Non-English Study?",
                    },
                    {
                      selector: 'input[name="study_complete"]',
                      isCheckbox: true,
                      label: "Final Report?",
                    },
                    {
                      selector: 'input[name="adverse_events"]',
                      isCheckbox: true,
                      label: "Adverse Events?",
                    },
                    {
                      selector: 'input[name="lincoln_lab"]',
                      isCheckbox: true,
                      label: "Lincoln Lab Affiliated?",
                    },
                    {
                      selector: 'input[name="submitting_genomic_data"]',
                      isCheckbox: true,
                      label: "Submitting Genomic Data?",
                    },
                    {
                      selector: 'input[name="conducting_interviews"]',
                      isCheckbox: true,
                      label: "Conducting Interviews?",
                    },
                    {
                      selector: 'input[name="mit_reviewing_irb"]',
                      isCheckbox: true,
                      label: "MIT as Reviewing IRB?",
                    },
                    {
                      selector: 'input[name="dod_funded"]',
                      isCheckbox: true,
                      label: "DoD-Funded?",
                    },
                  ]
                );
                break;

              // X. Final Report Closure
              case "study_complete":
                setupDownload(
                  tabDiv,
                  "#downloadFinalReportBtn",
                  "Final_Report_Closure.txt",
                  [
                    {
                      selector: 'input[name="study_title"]',
                      label: "Title of Study",
                    },
                    {
                      selector: 'textarea[name="pi_info"]',
                      label: "PI Name & Contact",
                    },
                    {
                      selector: 'textarea[name="closure_reason"]',
                      label: "Reason for Closure",
                    },
                    {
                      selector: 'input[name="subjects_count"]',
                      label: "Subjects Consented",
                    },
                    {
                      selector: 'input[name="withdrawals"]',
                      label: "Withdrawals",
                    },
                    {
                      selector: 'select[name="unreported"]',
                      label: "Unreported AEs or Complaints?",
                    },
                    {
                      selector: 'textarea[name="findings"]',
                      label: "Summary of Final Findings",
                    },
                    { selector: 'input[name="pi_sig"]', label: "PI Signature" },
                    { selector: 'input[name="pi_date"]', label: "PI Date" },
                    {
                      selector: 'input[name="dept_sig"]',
                      label: "Dept Head Signature",
                    },
                    {
                      selector: 'input[name="dept_date"]',
                      label: "Dept Head Date",
                    },
                  ]
                );
                break;

              // XI. DoD-Exempt Application
              case "dod_funded":
                setupDownload(
                  tabDiv,
                  "#downloadDoDExemptBtn",
                  "DoD_Exempt_Application.txt",
                  [
                    {
                      selector: 'input[name="title"]',
                      label: "Title of Study",
                    },
                    {
                      selector: 'input[name="exempt_number"]',
                      label: "Exempt Eval #",
                    },
                    {
                      selector: 'input[name="pi_name"]',
                      label: "Principal Investigator",
                    },
                    {
                      selector: 'input[name="faculty_sponsor"]',
                      label: "Faculty Sponsor",
                    },
                    { selector: 'input[name="poc_name"]', label: "PoC Name" },
                    { selector: 'input[name="poc_email"]', label: "PoC Email" },
                    {
                      selector: 'input[name="prop_number"]',
                      label: "Proposal #",
                    },
                    {
                      selector: 'input[name="prop_sponsor"]',
                      label: "Funding Sponsor",
                    },
                    {
                      selector: 'input[name="prop_title"]',
                      label: "Funding Title",
                    },
                    {
                      selector: 'input[name="award_number"]',
                      label: "Award #",
                    },
                    {
                      selector: 'input[name="award_sponsor"]',
                      label: "Award Sponsor",
                    },
                    {
                      selector: 'input[name="inst_funding"]',
                      label: "Institutional Funding",
                    },
                    {
                      selector: 'input[name="finA"]',
                      isCheckbox: true,
                      label: "Financial Interest?",
                    },
                    {
                      selector: 'textarea[name="collabs"]',
                      label: "Collaborating Institutions",
                    },
                    {
                      selector: 'textarea[name="location"]',
                      label: "Location of Research",
                    },
                    {
                      selector: 'select[name="intl_data"]',
                      label: "EEA/UK Data?",
                    },
                    {
                      selector: 'select[name="intl_fund"]',
                      label: "China/Russia/Saudi Funding?",
                    },
                    {
                      selector: 'textarea[name="purpose"]',
                      label: "Purpose & Procedures",
                    },
                    {
                      selector: 'select[name="prospective"]',
                      label: "Prospectively Assigned?",
                    },
                    {
                      selector: 'select[name="evaluate"]',
                      label: "Evaluate Effect?",
                    },
                    {
                      selector: 'select[name="health_outcome"]',
                      label: "Health-Related Outcome?",
                    },
                    {
                      selector: 'textarea[name="exp_procedures"]',
                      label: "Experimental Procedures",
                    },
                    {
                      selector: 'input[name="max_subjects"]',
                      label: "Max Subjects",
                    },
                    { selector: 'input[name="num_adults"]', label: "Adults" },
                    { selector: 'input[name="num_minors"]', label: "Minors" },
                    {
                      selector: 'textarea[name="age_ranges"]',
                      label: "Age Ranges",
                    },
                    {
                      selector: 'textarea[name="criteria"]',
                      label: "Inclusion/Exclusion Criteria",
                    },
                    {
                      selector: 'textarea[name="vulnerable"]',
                      label: "Vulnerable Populations",
                    },
                    {
                      selector: 'textarea[name="recruitment"]',
                      label: "Recruitment Methods",
                    },
                    {
                      selector: 'input[name="consent_form"]',
                      isCheckbox: false,
                      label: "Consent Form Attached?",
                    },
                    {
                      selector: 'textarea[name="payment"]',
                      label: "Subject Payment",
                    },
                    {
                      selector: 'textarea[name="reimbursement"]',
                      label: "Travel Reimbursement",
                    },
                    { selector: 'textarea[name="risks"]', label: "Risks" },
                    {
                      selector: 'textarea[name="minimization"]',
                      label: "Minimization Procedures",
                    },
                    {
                      selector: 'textarea[name="benefits_subjects"]',
                      label: "Benefits to Subjects",
                    },
                    {
                      selector: 'textarea[name="benefits_society"]',
                      label: "Benefits to Society",
                    },
                    {
                      selector: 'textarea[name="data_collection"]',
                      label: "Collection Methods",
                    },
                    { selector: 'select[name="av"]', label: "Audio/Video?" },
                    {
                      selector: 'textarea[name="av_explain"]',
                      label: "If Yes, Explain",
                    },
                    {
                      selector: 'select[name="coding"]',
                      label: "Coded or Identifiable?",
                    },
                    {
                      selector: 'textarea[name="storage"]',
                      label: "Storage & Security",
                    },
                    {
                      selector: 'textarea[name="disposition"]',
                      label: "Post-Study Disposition",
                    },
                    {
                      selector: 'textarea[name="relationship"]',
                      label: "Relationship Impact",
                    },
                    {
                      selector: 'select[name="deception"]',
                      label: "Deception?",
                    },
                    {
                      selector: 'textarea[name="deception_justify"]',
                      label: "Deception Justification",
                    },
                    {
                      selector: 'textarea[name="ae_followup"]',
                      label: "Adverse Event Follow-up",
                    },
                    {
                      selector: 'select[name="use_phi"]',
                      label: "Use of PHI?",
                    },
                    {
                      selector: 'select[name="waiver"]',
                      label: "Waiver of Auth?",
                    },
                    {
                      selector: 'textarea[name="waiver_rationale"]',
                      label: "Waiver Rationale",
                    },
                    {
                      selector: 'select[name="deidentified"]',
                      label: "De-identified?",
                    },
                    {
                      selector: 'select[name="limited_ds"]',
                      label: "Limited Data Set?",
                    },
                    {
                      selector: 'input[name="personnel_list"]',
                      label: "Personnel List Attached?",
                    },
                  ]
                );
                break;

              // XII. Consent to Participate in Interview
              case "conducting_interviews":
                setupDownload(
                  tabDiv,
                  "#downloadConsentInterviewBtn",
                  "Consent_Interview.txt",
                  [
                    {
                      selector: 'input[name="study_title"]',
                      label: "Study Title",
                    },
                    {
                      selector: 'input[name="investigator"]',
                      label: "Investigator Name & Dept",
                    },
                    {
                      selector: 'input[name="time_estimate"]',
                      label: "Estimated Interview Time",
                    },
                    {
                      selector: 'textarea[name="risks"]',
                      label: "Risks & Discomforts",
                    },
                    {
                      selector: 'textarea[name="benefits"]',
                      label: "Benefits",
                    },
                    {
                      selector: 'select[name="compensation"]',
                      label: "Compensation?",
                    },
                    {
                      selector: 'textarea[name="compensation_details"]',
                      label: "Compensation Details",
                    },
                    {
                      selector: 'input[name="record_permission"]',
                      multiple: true,
                      label: "Recording Permission",
                    },
                    {
                      selector: 'textarea[name="revocation"]',
                      label: "Recording Revocation Policy",
                    },
                    {
                      selector: 'textarea[name="storage_duration"]',
                      label: "Storage Duration",
                    },
                    {
                      selector: 'input[name="pub_name"]',
                      multiple: true,
                      label: "Include Name in Publication",
                    },
                    {
                      selector: 'input[name="pub_title"]',
                      multiple: true,
                      label: "Include Title in Publication",
                    },
                    {
                      selector: 'input[name="pub_quotes"]',
                      multiple: true,
                      label: "Include Direct Quotes",
                    },
                    {
                      selector: 'textarea[name="gdpr_data"]',
                      label: "GDPR Data Types",
                    },
                    {
                      selector: 'textarea[name="gdpr_security"]',
                      label: "GDPR Security",
                    },
                    {
                      selector: 'textarea[name="gdpr_retention"]',
                      label: "GDPR Retention Period",
                    },
                    {
                      selector: 'input[name="withdrawal_contact"]',
                      label: "Withdrawal Contact",
                    },
                    {
                      selector: 'textarea[name="data_transfer"]',
                      label: "International Transfer",
                    },
                    {
                      selector: 'input[name="participant_name"]',
                      label: "Participant Name",
                    },
                    {
                      selector: 'input[name="participant_date"]',
                      label: "Participant Date",
                    },
                    {
                      selector: 'input[name="consenter_name"]',
                      label: "Consent Obtainer",
                    },
                    {
                      selector: 'input[name="consenter_date"]',
                      label: "Consent Obtainer Date",
                    },
                  ]
                );
                break;

              // XIII. Assent to Participate in Research
              case "involves_minors":
                setupDownload(tabDiv, "#downloadAssentBtn", "Assent_Form.txt", [
                  {
                    selector: 'input[name="study_title"]',
                    label: "Study Title",
                  },
                  {
                    selector: 'input[name="child_name"]',
                    label: "Child‚Äôs Name",
                  },
                  {
                    selector: 'textarea[name="purpose"]',
                    label: "Why You Are Asked",
                  },
                  {
                    selector: 'textarea[name="procedures"]',
                    label: "What Will Happen",
                  },
                  { selector: 'textarea[name="risks"]', label: "Risks" },
                  { selector: 'textarea[name="benefits"]', label: "Benefits" },
                  {
                    selector: 'input[name="phone"]',
                    label: "Questions Contact",
                  },
                  {
                    selector: 'input[name="signature"]',
                    label: "Child‚Äôs Signature",
                  },
                  { selector: 'input[name="date"]', label: "Date" },
                ]);
                break;

              // XIV. Additional Standard Language
              case "additionalstandard":
                setupDownload(
                  tabDiv,
                  "#downloadAdditionalLanguageBtn",
                  "Additional_Standard_Language.txt",
                  [
                    {
                      selector: 'input[name="pi_lab_name"]',
                      label: "PI Name for Student/Lab Clause",
                    },
                    {
                      selector: 'input[name="lang_selfexp"]',
                      multiple: true,
                      label: "Self-Experimentation Language?",
                    },
                    {
                      selector: 'input[name="lang_random"]',
                      multiple: true,
                      label: "Randomization Language?",
                    },
                    {
                      selector: 'textarea[name="random_text"]',
                      label: "Randomization Details",
                    },
                    {
                      selector: 'input[name="lang_focus"]',
                      multiple: true,
                      label: "Focus Group Confidentiality?",
                    },
                    {
                      selector: 'input[name="lang_mri"]',
                      multiple: true,
                      label: "MRI Risk Language?",
                    },
                    {
                      selector: 'input[name="lang_sim"]',
                      multiple: true,
                      label: "Simulator Sickness Language?",
                    },
                    {
                      selector: 'input[name="lang_vr"]',
                      multiple: true,
                      label: "VR Side-Effects Language?",
                    },
                    {
                      selector: 'input[name="lang_incident_mri"]',
                      multiple: true,
                      label: "Incidental Findings Language?",
                    },
                    {
                      selector: 'input[name="lang_genomic"]',
                      multiple: true,
                      label: "Whole Genome Language?",
                    },
                    {
                      selector: 'textarea[name="genomic_details"]',
                      label: "Genomic Details",
                    },
                    {
                      selector: 'input[name="lang_optin"]',
                      multiple: true,
                      label: "Sequencing Opt-In/Out?",
                    },
                    {
                      selector: 'input[name="optin_yes"]',
                      multiple: true,
                      label: "Opt-In?",
                    },
                    {
                      selector: 'input[name="optin_no"]',
                      multiple: true,
                      label: "Opt-Out?",
                    },
                    {
                      selector: 'input[name="lang_gds"]',
                      multiple: true,
                      label: "GDS Policy Language?",
                    },
                  ]
                );
                break;
            }
          }
        }
        // Ensure tabs bar is visible if extra tabs exist
if (extraFormsNeeded.length > 0) {
  document.getElementById("tabs-nav").style.display = "flex";
}


        // Step 4: Create universal Save Draft button
        const saveBtnTemplate = document.createElement("button");
        saveBtnTemplate.textContent = "üíæ Save Draft";
        saveBtnTemplate.className = "universal-save-btn";
        saveBtnTemplate.style.marginTop = "30px";

        async function handleSave(e) {
          const btn = e.target;
          btn.textContent = "üíæ Saving...";

          const title =
            document.getElementById("section-1")?.value || "Untitled";

          const sections = {};
          for (let id of sectionIds) {
            const el = document.getElementById(id);
            if (el) sections[id] = el.value;
          }

          const extraForms = {};
          document.querySelectorAll(".tab-content form").forEach((form) => {
            const formId =
              form.closest("[data-form-id]")?.getAttribute("data-form-id") ||
              form.getAttribute("id") ||
              "unknown_form";
            const inputs = form.querySelectorAll("input, textarea, select");

            const data = {};
            inputs.forEach((input) => {
              if (input.type === "checkbox") {
                if (!data[input.name]) data[input.name] = [];
                if (input.checked) data[input.name].push(input.value);
              } else if (input.type === "radio") {
                if (input.checked) data[input.name] = input.value;
              } else {
                data[input.name] = input.value;
              }
            });

            extraForms[formId] = data;
          });

          const response = await fetch("/save-draft", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ title, sections, extraForms }),
          });

          if (response.ok) {
            btn.textContent = "‚úÖ Saved!";
            setTimeout(() => (btn.textContent = "üíæ Save Draft"), 2000);
          } else {
            btn.textContent = "‚ùå Save Failed";
          }
        }

        // Step 5: Add Save button to all tabs
        document.querySelectorAll(".tab-content > div").forEach((tab) => {
          const btnClone = saveBtnTemplate.cloneNode(true);
          btnClone.addEventListener("click", handleSave);
          tab.appendChild(btnClone);
        });

        // Step 6: Enable tab-switching behavior
        nav.addEventListener("click", (e) => {
          if (e.target.tagName === "LI") {
            const selectedTab = e.target.dataset.tab;
            nav
              .querySelectorAll("li")
              .forEach((item) =>
                item.classList.toggle(
                  "active",
                  item.dataset.tab === selectedTab
                )
              );
            content
              .querySelectorAll(":scope > div")
              .forEach(
                (div) =>
                  (div.style.display =
                    div.id === `tab-${selectedTab}` ? "block" : "none")
              );
          }
        });

        // Step 7: Show the first visible tab
        setTimeout(() => {
          const firstTab = nav.querySelector("li");
          if (firstTab) {
            firstTab.classList.add("active");
            const tabId = firstTab.dataset.tab;
            const tabContent = document.getElementById(`tab-${tabId}`);
            if (tabContent) {
              tabContent.style.display = "block";
            }
          }
        }, 100);

        // Step 8: Load saved data if we have it
        if (savedDraft) {
          // Load main sections
          if (savedDraft.sections) {
            for (let id of sectionIds) {
              if (savedDraft.sections[id]) {
                const element = document.getElementById(id);
                if (element) {
                  element.value = savedDraft.sections[id];
                  console.log(
                    `‚úÖ Loaded section ${id}:`,
                    savedDraft.sections[id].substring(0, 50) + "..."
                  );
                }
              }
            }
          }

          // Load extra form data
          if (savedDraft.extraForms) {
            for (const [formId, savedInputs] of Object.entries(
              savedDraft.extraForms
            )) {
              const waitForForm = async () => {
                const formWrapper =
                  document.querySelector(`[data-form-id="${formId}"] form`) ||
                  document.getElementById(formId);
                if (!formWrapper) {
                  console.warn(`‚è≥ Waiting for form ${formId}...`);
                  setTimeout(waitForForm, 300);
                  return;
                }

                for (const [key, value] of Object.entries(savedInputs)) {
                  const inputs = formWrapper.querySelectorAll(
                    `[name="${key}"]`
                  );
                  inputs.forEach((input) => {
                    if (input.type === "checkbox") {
                      input.checked =
                        Array.isArray(value) && value.includes(input.value);
                    } else if (input.type === "radio") {
                      input.checked = input.value === value;
                    } else {
                      input.value = value;
                    }
                  });
                }
                console.log(`‚úÖ Loaded form data for ${formId}`);
              };
              waitForForm();
            }
          }
        }
      });

      function inviteCollaborator() {
        const inviteEmail = document.getElementById("invite-email").value;
        const params = new URLSearchParams(window.location.search);
        const draftTitle = params.get("draftTitle") || "Untitled";

        fetch("/invite-collaborator", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ draftTitle, inviteEmail }),
        })
          .then((res) => res.json())
          .then((data) => {
            document.getElementById("invite-status").textContent = data.message;
            document.getElementById("invite-email").value = "";
          })
          .catch((err) => {
            console.error("Error inviting collaborator:", err);
            document.getElementById("invite-status").textContent =
              "‚ùå Invite failed.";
          });
      }
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {
        // 1Ô∏è‚É£ Configure & clear any leftover bar
        NProgress.configure({ showSpinner: false });
        NProgress.done();

        // 2Ô∏è‚É£ Start on any <button> click
        document.body.addEventListener("click", (e) => {
          if (e.target.closest("button")) {
            NProgress.start();
          }
        });

        // 3Ô∏è‚É£ Finish on full-page navigations
        window.addEventListener("pageshow", () => {
          NProgress.done();
        });

        // 4Ô∏è‚É£ Wrap fetch() so AJAX calls drive the bar too
        (function (origFetch) {
          window.fetch = function (...args) {
            NProgress.start();
            return origFetch(...args)
              .then((res) => {
                NProgress.done();
                return res;
              })
              .catch((err) => {
                NProgress.done();
                throw err;
              });
          };
        })(window.fetch);
      });
    </script>
    <script>
  document.getElementById("submit-final").addEventListener("click", async () => {
    const confirmed = confirm("Are you sure you want to submit this draft as final? You won‚Äôt be able to edit it afterward.");
    if (!confirmed) return;
    // üõë Prevent save/resave
  Object.values(autosaveTimers).forEach(clearTimeout);
  document.querySelectorAll(".universal-save-btn").forEach(btn => {
    btn.disabled = true;
    btn.textContent = "‚è≥ Submitting...";
  });


    const draftTitle = document.getElementById("section-1")?.value || "Untitled";

    const sections = {};
    for (let id of sectionIds) {
      const el = document.getElementById(id);
      if (el) sections[id] = el.value;
    }

// Collect extraForms just like in save
const extraForms = {};
document.querySelectorAll(".tab-content form").forEach((form) => {
  const formId =
    form.closest("[data-form-id]")?.getAttribute("data-form-id") ||
    form.getAttribute("id") ||
    "unknown_form";
  const inputs = form.querySelectorAll("input, textarea, select");

  const data = {};
  inputs.forEach((input) => {
    if (input.type === "checkbox") {
      if (!data[input.name]) data[input.name] = [];
      if (input.checked) data[input.name].push(input.value);
    } else if (input.type === "radio") {
      if (input.checked) data[input.name] = input.value;
    } else {
      data[input.name] = input.value;
    }
  });

  extraForms[formId] = data;
});

const response = await fetch("/submit-final-draft", {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({
    title: draftTitle,
    sections,
    extraForms: extraForms, // ‚úÖ include this
  }),
});


    if (response.ok) {
      alert(`‚úÖ Submitted "${draftTitle}" successfully!`);
      window.location.href = "/dashboard";
    } else {
      alert("‚ùå Submission failed. Try again.");
    }

  });
  // ‚úÖ Attach tab-switch behavior AFTER all tabs are loaded
document.querySelectorAll(".tabs-nav li").forEach((tab) => {
  tab.addEventListener("click", () => {
    const selectedTab = tab.dataset.tab;

    document.querySelectorAll(".tabs-nav li").forEach((t) =>
      t.classList.toggle("active", t === tab)
    );

    document.querySelectorAll(".tab-content > div").forEach((div) => {
      div.style.display = div.id === `tab-${selectedTab}` ? "block" : "none";
    });
  });
});

// ‚úÖ Ensure first visible tab is active
const firstTab = document.querySelector(".tabs-nav li");
if (firstTab) {
  firstTab.classList.add("active");
  const tabId = firstTab.dataset.tab;
  const tabContent = document.getElementById(`tab-${tabId}`);
  if (tabContent) {
    tabContent.style.display = "block";
  }
}

</script>

  </body>
</html>
